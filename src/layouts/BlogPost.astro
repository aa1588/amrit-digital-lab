---
import BaseLayout from './BaseLayout.astro';
import SeriesNav from '../components/SeriesNav.astro';
import CopyCodeButton from '../components/CopyCodeButton.astro';
import Comments from '../components/Comments.astro';
import ShareButtons from '../components/ShareButtons.astro';
import ReadingProgress from '../components/ReadingProgress.astro';
import TableOfContents from '../components/TableOfContents.astro';
import { calculateReadingTime } from '../utils/readingTime';

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  author: string;
  image?: string;
  tags?: string[];
  series?: string;
  slug: string;
}

const { title, description, pubDate, author, image, tags = [], series, slug } = Astro.props;
const formattedDate = new Date(pubDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Get the rendered content for reading time calculation
const content = await Astro.slots.render('default');
const readingTime = calculateReadingTime(content);

// Get the full URL for sharing
const currentUrl = new URL(Astro.url.pathname, Astro.site).toString();
---

<BaseLayout title={title} description={description} image={image} article={true} hideThemeToggle={true}>
  <ReadingProgress />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet">
  
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": title,
    "description": description,
    "image": image ? new URL(image, Astro.site).toString() : undefined,
    "datePublished": pubDate.toISOString(),
    "author": {
      "@type": "Person",
      "name": author,
      "url": "https://yourdomain.com/about"
    },
    "publisher": {
      "@type": "Organization",
      "name": "DigitalLab",
      "logo": {
        "@type": "ImageObject",
        "url": new URL('/logo.png', Astro.site).toString()
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": new URL(Astro.url.pathname, Astro.site).toString()
    }
  })} />
  <article class="blog-post">
    <div class="container">
      <header class="post-header">
        {image && <img src={image} alt={title} class="hero-image" />}
        <h1>{title}</h1>
        <div class="post-meta">
          <time datetime={pubDate.toISOString()}>{formattedDate}</time>
          <span>â€¢</span>
          <span>{author}</span>
          <span>â€¢</span>
          <span class="reading-time">ðŸ“– {readingTime}</span>
        </div>
        {tags.length > 0 && (
          <div class="tags">
            {tags.map(tag => (
              <a href={`${import.meta.env.BASE_URL}blog/?tag=${tag}`} class="tag">{tag}</a>
            ))}
          </div>
        )}
      </header>

      <div class="prose">
        <slot />
      </div>

      <ShareButtons title={title} url={currentUrl} />

      {series && <SeriesNav currentSlug={slug} seriesName={series} />}
    </div>
  </article>
  
  <Comments />

  <TableOfContents />
  <CopyCodeButton />

  <!-- Anchor links on headings and code language labels -->
  <script>
    function enhanceBlogPost() {
      const prose = document.querySelector('.prose');
      if (!prose) return;

      // Add anchor links to headings
      const headings = prose.querySelectorAll('h2, h3, h4');
      headings.forEach((heading, index) => {
        // Create ID if doesn't exist
        if (!heading.id) {
          heading.id = heading.textContent
            ?.toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/(^-|-$)/g, '') || `heading-${index}`;
        }

        // Add anchor link at the end of heading
        const anchor = document.createElement('a');
        anchor.href = `#${heading.id}`;
        anchor.className = 'heading-anchor';
        anchor.setAttribute('aria-label', 'Link to this section');
        anchor.textContent = '#';
        heading.appendChild(anchor);
        heading.classList.add('has-anchor');
      });

      // Add language labels to code blocks
      const codeBlocks = document.querySelectorAll('pre');
      codeBlocks.forEach(pre => {
        const code = pre.querySelector('code');
        if (!code) return;

        // Get language from class (e.g., "language-javascript" or from data attribute)
        let language = '';
        const classList = code.className.split(' ');
        for (const cls of classList) {
          if (cls.startsWith('language-')) {
            language = cls.replace('language-', '');
            break;
          }
        }

        // Also check data-language attribute (Shiki uses this)
        if (!language && pre.dataset.language) {
          language = pre.dataset.language;
        }

        // Check the astro-code class for Shiki
        if (!language) {
          const astroCode = pre.querySelector('.astro-code');
          if (astroCode && astroCode.dataset.language) {
            language = astroCode.dataset.language;
          }
        }

        // Format language name
        const languageMap: Record<string, string> = {
          'js': 'JavaScript',
          'javascript': 'JavaScript',
          'ts': 'TypeScript',
          'typescript': 'TypeScript',
          'tsx': 'TSX',
          'jsx': 'JSX',
          'py': 'Python',
          'python': 'Python',
          'rb': 'Ruby',
          'ruby': 'Ruby',
          'go': 'Go',
          'rust': 'Rust',
          'rs': 'Rust',
          'java': 'Java',
          'kotlin': 'Kotlin',
          'kt': 'Kotlin',
          'swift': 'Swift',
          'c': 'C',
          'cpp': 'C++',
          'c++': 'C++',
          'cs': 'C#',
          'csharp': 'C#',
          'php': 'PHP',
          'sql': 'SQL',
          'html': 'HTML',
          'css': 'CSS',
          'scss': 'SCSS',
          'sass': 'Sass',
          'json': 'JSON',
          'yaml': 'YAML',
          'yml': 'YAML',
          'xml': 'XML',
          'md': 'Markdown',
          'markdown': 'Markdown',
          'bash': 'Bash',
          'sh': 'Shell',
          'shell': 'Shell',
          'zsh': 'Zsh',
          'dockerfile': 'Dockerfile',
          'docker': 'Docker',
          'graphql': 'GraphQL',
          'vue': 'Vue',
          'svelte': 'Svelte',
          'astro': 'Astro',
          'toml': 'TOML',
          'ini': 'INI',
          'properties': 'Properties',
          'diff': 'Diff',
          'http': 'HTTP',
          'text': 'Text',
          'txt': 'Text',
          'plaintext': 'Text',
        };

        const displayName = languageMap[language.toLowerCase()] || (language ? language.charAt(0).toUpperCase() + language.slice(1) : '');

        if (displayName) {
          // Create wrapper if needed
          if (!pre.parentElement?.classList.contains('code-block-wrapper')) {
            const wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            pre.parentNode?.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
          }

          // Add language label
          const label = document.createElement('div');
          label.className = 'code-language-label';
          label.textContent = displayName;
          pre.parentElement?.insertBefore(label, pre);
        }
      });
    }

    // Run after DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', enhanceBlogPost);
    } else {
      enhanceBlogPost();
    }
  </script>
</BaseLayout>

<style>
  .blog-post {
    padding: 4rem 0;
  }

  .container {
    max-width: 720px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .post-header {
    margin-bottom: 3rem;
    text-align: center;
  }

  .hero-image {
    width: 100%;
    border-radius: var(--radius-xl);
    margin-bottom: 2.5rem;
    box-shadow: var(--shadow-hover);
  }

  h1 {
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 2.75rem;
    line-height: 1.2;
    margin-bottom: 1.25rem;
    color: var(--color-text);
    font-weight: 700;
    letter-spacing: -0.03em;
  }

  .post-meta {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    justify-content: center;
    color: var(--color-text-secondary);
    font-size: 0.9375rem;
    margin-bottom: 1.25rem;
    flex-wrap: wrap;
    font-family: 'Plus Jakarta Sans', sans-serif;
  }

  .post-meta span:not(.reading-time) {
    opacity: 0.5;
  }

  .reading-time {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-weight: 500;
    color: var(--color-accent);
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
  }

  .tag {
    background: var(--color-accent-light);
    padding: 0.375rem 0.875rem;
    border-radius: var(--radius-xl);
    font-size: 0.8125rem;
    color: var(--color-accent);
    border: none;
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .tag:hover {
    background: var(--color-accent);
    color: white;
  }

  .prose {
    font-size: 1.125rem;
    line-height: 1.9;
    color: var(--color-text);
  }

  /* Headings */
  .prose :global(h2) {
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 1.75rem;
    margin-top: 3.5rem;
    margin-bottom: 1.25rem;
    color: var(--color-text);
    font-weight: 700;
    line-height: 1.3;
    letter-spacing: -0.02em;
    position: relative;
    padding-left: 1rem;
  }

  .prose :global(h2)::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0.25em;
    bottom: 0.25em;
    width: 4px;
    background: linear-gradient(180deg, var(--color-accent), var(--color-accent-secondary));
    border-radius: 2px;
  }

  .prose :global(h3) {
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 1.375rem;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    color: var(--color-text);
    font-weight: 600;
    line-height: 1.4;
    letter-spacing: -0.01em;
  }

  .prose :global(h4) {
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 1.125rem;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    color: var(--color-text-secondary);
    font-weight: 600;
    line-height: 1.4;
  }

  /* Paragraphs */
  .prose :global(p) {
    margin-bottom: 1.75rem;
  }

  /* Lists */
  .prose :global(ul), .prose :global(ol) {
    margin-bottom: 1.75rem;
    padding-left: 1.25rem;
  }

  .prose :global(ul) {
    list-style-type: none;
  }

  .prose :global(ul > li) {
    position: relative;
    padding-left: 1.25rem;
  }

  .prose :global(ul > li)::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0.7em;
    width: 6px;
    height: 6px;
    background: var(--color-accent);
    border-radius: 50%;
  }

  .prose :global(ol) {
    list-style-type: decimal;
    padding-left: 1.5rem;
  }

  .prose :global(li) {
    margin-bottom: 0.75rem;
  }

  .prose :global(ol > li)::marker {
    color: var(--color-accent);
    font-weight: 600;
    font-family: 'Plus Jakarta Sans', sans-serif;
  }

  .prose :global(li > ul), .prose :global(li > ol) {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }

  /* Links */
  .prose :global(a) {
    color: var(--color-accent);
    text-decoration: underline;
    text-decoration-color: rgba(224, 122, 95, 0.3);
    text-underline-offset: 3px;
    text-decoration-thickness: 2px;
    transition: all 0.2s ease;
  }

  .prose :global(a:hover) {
    text-decoration-color: var(--color-accent);
  }

  /* Blockquotes */
  .prose :global(blockquote) {
    border-left: 4px solid var(--color-accent);
    padding: 1.25rem 1.75rem;
    margin: 2.5rem 0;
    background: var(--color-accent-light);
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    color: var(--color-text);
    font-style: italic;
    position: relative;
  }

  .prose :global(blockquote)::before {
    content: '"';
    position: absolute;
    top: -0.25rem;
    left: 1rem;
    font-size: 3rem;
    color: var(--color-accent);
    opacity: 0.3;
    font-family: Georgia, serif;
    line-height: 1;
  }

  .prose :global(blockquote p) {
    margin-bottom: 0;
  }

  .prose :global(blockquote p + p) {
    margin-top: 1rem;
  }

  /* Images */
  .prose :global(img) {
    margin: 2.5rem auto;
    display: block;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-hover);
  }

  /* Tables */
  .prose :global(.table-wrapper) {
    overflow-x: auto;
    margin: 2.5rem 0;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    box-shadow: var(--shadow);
  }

  .prose :global(table) {
    width: 100%;
    min-width: 600px;
    border-collapse: collapse;
    font-size: 0.9375rem;
  }

  .prose :global(table):not(.table-wrapper table) {
    margin: 2.5rem 0;
    display: block;
    overflow-x: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    box-shadow: var(--shadow);
  }

  .prose :global(thead) {
    background: var(--color-bg-warm);
  }

  .prose :global(th) {
    padding: 1rem 1.25rem;
    text-align: left;
    font-weight: 600;
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.8125rem;
    color: var(--color-text);
    border-bottom: 2px solid var(--color-border);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .prose :global(td) {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--color-border);
    vertical-align: top;
  }

  .prose :global(tbody tr:hover) {
    background: var(--color-bg-warm);
  }

  .prose :global(tbody tr:last-child td) {
    border-bottom: none;
  }

  /* Horizontal Rules */
  .prose :global(hr) {
    border: none;
    height: 2px;
    background: var(--color-border);
    margin: 3.5rem auto;
    width: 60%;
    border-radius: 1px;
  }

  /* Code blocks - additional prose-specific styling */
  .prose :global(pre) {
    margin: 2rem 0;
    font-size: 0.9rem;
    border-radius: var(--radius-md);
    overflow-x: auto;
    white-space: pre;
    max-height: 600px;
    overflow-y: auto;
  }

  .prose :global(pre code) {
    white-space: pre;
    word-break: normal;
    overflow-wrap: normal;
  }

  /* Strong and emphasis */
  .prose :global(strong) {
    font-weight: 600;
    color: var(--color-text);
  }

  .prose :global(em) {
    font-style: italic;
  }

  /* Drop cap - first letter of first paragraph */
  .prose :global(> p:first-of-type::first-letter) {
    float: left;
    font-size: 4rem;
    line-height: 1;
    font-weight: 700;
    margin-right: 0.75rem;
    margin-top: 0.125rem;
    color: var(--color-accent);
    font-family: 'Plus Jakarta Sans', sans-serif;
  }

  /* Heading anchor links */
  .prose :global(.heading-anchor) {
    opacity: 0;
    color: var(--color-border);
    text-decoration: none;
    transition: opacity 0.2s ease, color 0.2s ease;
    margin-left: 0.5rem;
    font-weight: 400;
  }

  .prose :global(.has-anchor:hover .heading-anchor) {
    opacity: 1;
  }

  .prose :global(.heading-anchor:hover) {
    color: var(--color-accent);
  }

  /* Code block wrapper and language label */
  .prose :global(.code-block-wrapper) {
    position: relative;
    margin: 2rem 0;
  }

  .prose :global(.code-block-wrapper pre) {
    margin: 0;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
  }

  .prose :global(.code-language-label) {
    display: inline-block;
    background: var(--color-accent);
    color: white;
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.6875rem;
    font-weight: 600;
    padding: 0.375rem 0.875rem;
    border-radius: var(--radius-md) var(--radius-md) 0 0;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Mobile adjustments */
  @media (max-width: 768px) {
    h1 {
      font-size: 2rem;
    }

    .prose :global(h2) {
      font-size: 1.5rem;
    }

    .prose :global(h3) {
      font-size: 1.25rem;
    }
  }
</style>
